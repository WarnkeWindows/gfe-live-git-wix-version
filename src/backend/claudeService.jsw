// File: /backend/claudeService.jsw

import { fetch } from 'wix-fetch';
import { getSecret } from 'wix-secrets-backend';

export async function measureExteriorFeatures({ 
    imageUrls, 
    referenceObject, 
    targetFeatures, 
    propertyContext, 
    userPrompt 
}) {
    const apiKey = await getSecret('ANTHROPIC_API_KEY');
    const systemPrompt = `
You are the Exterior Measurement AI for GoodFaithExteriors.com, a professional contractor specializing in windows, roofing, and siding.
[...your prompt continues...]
    `;

    const tool = {
        type: "custom",
        name: "exterior_window_analysis",
        description: "Analyze a window photo using post-it notes or other objects for scale and provide professional measurements, observations, and recommendations.",
        input_schema: {
            type: "object",
            properties: {
                image_urls: {
                    type: "array",
                    description: "Array of public URLs of the photos to analyze (multiple angles encouraged).",
                    items: { type: "string" }
                },
                reference_object: {
                    type: "string",
                    description: "The known-size object visible in some photos for scale (e.g. '3x3 inch post-it', 'letter-size paper 8.5x11', 'credit card', 'tape measure', or 'factory label')."
                },
                target_features: {
                    type: "array",
                    description: "List of features to measure and analyze. One or more of: 'roof', 'siding', 'windows', 'doors'.",
                    items: {
                        type: "string",
                        enum: ["roof", "siding", "windows", "doors"]
                    }
                },
                property_context: {
                    type: "string",
                    description: "Any extra context (e.g. '2-story colonial', '1940s rambler', 'storm restoration', 'insurance claim'). Optional.",
                    default: ""
                }
            },
            required: [
                "image_urls",
                "reference_object",
                "target_features"
            ]
        }
    };

    const body = {
        model: "claude-sonnet-4-20250514",
        max_tokens: 20000,
        temperature: 1,
        system: systemPrompt,
        messages: [
            {
                role: "user",
                content: [
                    { type: "text", text: userPrompt }
                ]
            }
        ],
        tools: [tool]
    };

    const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "x-api-key": apiKey,
            "anthropic-version": "2023-06-01"
        },
        body: JSON.stringify(body)
    });

    return await response.json();
}
